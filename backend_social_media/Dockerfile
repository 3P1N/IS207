# 1. DÃ¹ng PHP 8.2
FROM php:8.2-cli

# 2. CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t cho Linux
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    libpq-dev \
    libonig-dev \
    libzip-dev

# 3. CÃ i Ä‘áº·t extension PHP
RUN docker-php-ext-install pdo pdo_pgsql bcmath zip

# 4. CÃ i Ä‘áº·t Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 5. Thiáº¿t láº­p thÆ° má»¥c lÃ m viá»‡c
WORKDIR /var/www

# 6. Copy code vÃ o container
COPY . .

# ðŸ”¥ [FIX Lá»–I] Táº¡o cÃ¡c biáº¿n giáº£ Ä‘á»ƒ quÃ¡ trÃ¬nh Build khÃ´ng bá»‹ crash
# Render sáº½ ghi Ä‘Ã¨ cÃ¡c biáº¿n nÃ y báº±ng biáº¿n tháº­t khi cháº¡y (Runtime), nÃªn khÃ´ng lo báº£o máº­t.
ENV PUSHER_APP_KEY=temp_build_key
ENV PUSHER_APP_ID=temp_build_id
ENV PUSHER_APP_SECRET=temp_build_secret
ENV APP_KEY=base64:temp_key_for_build_process=================

# 7. Cháº¡y lá»‡nh cÃ i Ä‘áº·t thÆ° viá»‡n Laravel
# ThÃªm --no-scripts Ä‘á»ƒ an toÃ n hÆ¡n, trÃ¡nh cháº¡y code logic khi chÆ°a cÃ³ DB
RUN composer install --no-dev --optimize-autoloader --no-scripts

# 8. Má»Ÿ port
EXPOSE 8000

# 9. Lá»‡nh cháº¡y server (ThÃªm lá»‡nh package:discover cháº¡y lÃºc khá»Ÿi Ä‘á»™ng)
CMD php artisan package:discover --ansi && php artisan serve --host=0.0.0.0 --port=10000